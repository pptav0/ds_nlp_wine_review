
flowchart LR
A[Raw Reviews and Metadata] --> B[Preprocess Clean Concat]

subgraph CL [Classification Layer\nBERT / DistilBERT]
    B --> C1[Flavor Profile Classifier]
    B --> C2[Sentiment Quality Classifier]
    B --> C3[Variety Country Predictor]
end

C1 --> D[Enriched Records]
C2 --> D
C3 --> D

subgraph RET [Retrieval Layer]
    D --> E[Sentence Embeddings]
    E --> F[Semantic Search\nsentence_transformers.util.semantic_search]
end

subgraph UQF [User Query Flow]
    Q[User Query\nfruit juicy wine from Portugal] --> Q1[Facet Extraction\nCountry=PT · Flavor=Fruity/Juicy]
    Q1 --> E
    Q1 -. filters .-> K
end

subgraph REC [Recommendation Layer]
    F --> K[Candidate Set Top K]
    K --> L[LLM Reranker and Explanations]
    L --> M[Business Rules\nTwo Strict · One Exploratory]
    M --> N[Final Recommendations]
end
